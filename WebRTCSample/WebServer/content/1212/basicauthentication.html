<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/bootstrap-theme.min.css" />
    <link rel="stylesheet" href="css/font-awesome.min.css" />
    <link rel="stylesheet" href="css/toastr.min.css" />
    <link rel="stylesheet" href="css/Site.css" />

    <!-- Jquery -->
    <script src="scripts/jquery-1.9.1.min.js"></script>
    <!-- Bootstrap -->
    <script src="scripts/bootstrap.js"></script>
    <script src="scripts/toastr.min.js"></script>

    <script type="text/javascript" src="scripts/jsbn.js"></script>
    <script type="text/javascript" src="scripts/prng4.js"></script>
    <script type="text/javascript" src="scripts/rng.js"></script>
    <script type="text/javascript" src="scripts/rsa.js"></script>
    <script type="text/javascript" src="scripts/base64.js"></script>

    <meta charset="utf-8" />
    <title>WebRTC Basic Authentication</title>
</head>
<body>
    <div class="modal fade" id="modalAuthentication" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="lblModal">Please Authenticate</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Username</label>
                        <input id="authUsername" type="text" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input id="authPassword" type="password" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="authenticate();">Submit</button>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <audio id="sourceAudio" autoplay muted="true"></audio>
            <audio id="remoteAudio" autoplay></audio>

            <div class="container-fluid" id="content">

                <h1 class="hborder">Basic Authentication</h1>
                <p>
                    This application demonstrates how to program an authentication challenge between your browser and Voice Elements.
                </p>
                <p>
                    <button class="btn btn-default" id="btnConnect" onclick="btnConnectClick();">
                        Connect
                    </button>
                </p>
                <p>
                    <strong>Your Status:</strong>
                    <span id="lblStatus">Disconnected</span>
                </p>
                <p>
                    <strong>Note:</strong> <em>When prompted to enter your username and password, don't use a real password as it will be read back go you.</em> 
                </p>
                <pre id="evtLog">Event information log (Shown to demonstrate the data channel.)
--------------------------------------------------------------
                </pre>
                <script src="scripts/InventiveWebRTC.js"></script>

                <script type="text/javascript">
                    var evtLog = document.getElementById("evtLog");                    var btnConnect = document.getElementById("btnConnect");                    var lblStatus = document.getElementById("lblStatus");                    var authModulus;                    var authPublicExponent;
                    document.addEventListener("messageEvent", messageEventHandler, false);
                    document.addEventListener("socketStatusEvent", socketStatusEventHandler, false);
                    document.addEventListener("mediaStatusEvent", mediaStatusEventHandler, false);
                    document.addEventListener("authenticationEvent", authenticationEventHandler, false);
                    document.addEventListener("applicationMessageEvent", applicationMessageEventHandler, false);

                    function messageEventHandler(e) {
                        LogMessage(e.detail.time.toLocaleString() + ": " + e.detail.message);
                    }

                    function authenticationEventHandler(e) {
                        authModulus = b64tohex(e.detail.modulus);
                        authPublicExponent = b64tohex(e.detail.publicExponent);
                        $('#modalAuthentication').modal({ backdrop: 'static', keyboard: false });
                    }

                    function socketStatusEventHandler(e) {
                        switch (e.detail.status) {
                            case IVLSocketState.Disconnected:
                                LogMessage("IVLSocketState.Disconnected");
                                lblStatus.innerText = "Disconnected";
                                btnConnect.innerText = 'Connect';
                                btnConnect.disabled = false;
                                $('#modalAuthentication').modal('hide');
                                break;
                            case IVLSocketState.Permissions:
                                LogMessage("Asking User For Permission To Use Microphone.");
                                lblStatus.innerText = "Permissions";
                                btnConnect.innerText = 'Permissions';
                                btnConnect.disabled = true;
                                break;
                            case IVLSocketState.Connecting:
                                LogMessage("IVLSocketState.Connecting");
                                btnConnect.disabled = true;
                                lblStatus.innerText = "Connecting";
                                btnConnect.innerText = 'Connecting...';
                                break;
                            case IVLSocketState.Connected:
                                LogMessage("IVLSocketState.Connected");
                                lblStatus.innerText = "Connected";
                                btnConnect.innerText = 'Disconnect';
                                btnConnect.disabled = false;
                                break;
                            default:
                                LogMessage("Unknown Socket State");
                                LogMessage(e.detail.status);
                        }
                    }

                    function mediaStatusEventHandler(e) {
                    }

                    function applicationMessageEventHandler(e) {
                    }

                    // log event in console
                    function LogMessage(msg) {
                        evtLog.textContent += msg + "\n";
                        var ot = evtLog.scrollHeight - evtLog.clientHeight;
                        if (ot > 0) evtLog.scrollTop = ot;
                    }

                    function btnConnectClick() {
                        switch (btnConnect.innerText) {
                            case 'Connect':
                                if (location.protocol == 'https:') {
                                    IVLConnect('wss://webrtctest.voiceelements.com:61053/');
                                }
                                else {
                                    IVLConnect('ws://webrtctest.voiceelements.com:61052/');
                                } break;
                            case 'Disconnect':
                                IVLDisconnect();
                                lblStatus.innerText = "Disconnected";
                                btnConnect.innerText = 'Connect';
                                btnConnect.disabled = false;
                                break;
                        }
                    }                    function authenticate() {
                        var user = document.getElementById('authUsername').value;
                        var pass = document.getElementById('authPassword').value;

                        if (user && pass) {

                            $('#modalAuthenticate').modal('hide');

                            var rsa = new RSAKey();
                            rsa.setPublic(authModulus, authPublicExponent);
                            var res = rsa.encrypt(pass);
                            IVLAuthenticate(user, hex2b64(res));

                        }
                        else {
                            alert('You must enter a username and password!');
                            return;
                        }                    }
                </script>
            </div>

        </div>
        <div class="row">
            <div class="container-fluid" id="footer">
                <div id="inner-footer">
                    © 2016 Inventive Labs
                </div>
            </div>
        </div>
    </div>
</body>
</html>